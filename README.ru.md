# ePub-ReFreshing
## Тема ePub-ReFreshing для генератора статических сайтов HUGO.
Простой и удобный генератор электронных книг, для создания электронных книг в формате **ePub**, текст которых подготовлен в файлах .md.

## Формат ePub

При разработке темы учитываются **W3C Recommendation [epub3.3](https://www.w3.org/TR/epub-33)**.

Структура файла выглядит следующим образом:

```bash
├── mimetype
├── META-INF
│   └── container.xml
└── OEBPS
    ├── chapter
    │   ├── chapter-1.xhtml
    │   ├── chapter-1
    │   │   ├── image-1-1.jpg
    │   │   └── image-1-2.jpg
    │   ├── chapter-2.xhtml
    │   ├── chapter-3.xhtml
    │   ├── chapter-3
    │   │   └── image-3.jpg
    │   ...
    │
    ├── content.opf
    ├── cover.jpg
    ├── css
    │   └── stylesheet.css
    ├── inhaltsverzeichnis.xhtml
    ├── titelseite.xhtml
    └── toc.ncx
```

### Работа тема epub as HUGO

* `mimetype`, `container.xml` и `stylesheet.css` — это статические файлы, расположенные в каталоге `static/` темы ePub-ReFreshing.
* Изображение обложки `cover.jpg` находится в каталоге `static/OEBPS`.
Остальные файлы Hugo генерирует из MD-файлов содержащихся в папке **content** пользовательской части проекта HUGO:

``` bash
content
├── _index.md
├── inhaltsverzeichnis.md
├── blog
│   ├── chapter-1
│   │   ├── image-1-1.jpg
│   │   ├── image-1-2.jpg
│   │   └── index.md
│   ├── chapter-2.md
│   └── chapter-3
│       ├── image-3.jpg
│       └── index.md
└── titelseite.md
```

> В проекте Hugo 2 части: - «содержимое» (content) и «дизайн» (тема) ("Под словом «design» англоязычная литература начала XXI века понимает и стиль, и проект, и проектирование", [Википедия » Дизайн](https://ru.wikipedia.org/wiki/Дизайн))

Файл `index.md` создает центральные файлы `content.opf` и `toc.ncx` с помощью конфигурации в `config.toml` и макета темы. Настройка

```toml
cascade:
  _build:
    publishResources: false
```

in frontmatter гарантирует, что только масштабированные изображения попадут в папку с электронной книгой, а исходные файлы не будут скопированы вместе с ними — что в противном случае HUGO сделал бы по умолчанию.

inhaltsverzeichnis.md и titelseite.md создают эти необходимые страницы в электронной книге. Эти файлы нельзя удалять или переименовывать. Содержимое берется из параметров в config.toml . Во фронтмейстере параметр ebook: toc соотв. ebook: cover гарантирует, что шаблон single.xhtml обрабатывает эти особые случаи иначе, чем стандарт.

Фактический макет темы в themes/epub/layouts состоит всего из трех файлов:

├── _default
│   └── single.xhtml
├── index.ncx
├── index.opf
single.xhtml создает все страницы xhtml, index.ncx является шаблоном для toc.ncx , а index.opf создает content.opf . Все это управляется config.toml . Обычно эти три файла не нужно изменять. Также все файлы , используемые в книге, должны быть зарегистрированы в манифесте content.opf . Это происходит автоматически для всех файлов из папки содержимого. Но если, например, на страницах есть ссылки на статические изображения, их придется добавлять вручную в манифест . Это происходит в index.opf .

config.toml содержит все метаданные электронной книги и обеспечивает создание правильной файловой структуры:

disableKinds отключает почти все, что HUGO делает по умолчанию. Мы генерируем вывод только для страниц и для корневого файла _index.md .
постоянные ссылки играют важную роль. Здесь мы должны определить путь для каждого раздела , содержащегося в content/ . Я предопределил запись для «блога». Если должны быть другие или дополнительные разделы (это папки непосредственно под content/ ), в каждом случае необходимо добавить строку.
mediaTypes , outputFormats и outputs определяют три формата файлов, динамически генерируемых HUGO: xhtml, opf и ncx. Соответствующие шаблоны находятся в папке layouts/ темы.
разметка управляет интерпретацией файлов уценки и может быть настроена по желанию. Параметр xHTML = true менять нельзя.
params содержит метаданные электронной книги (название книги, автор и т. д.). Он также указывает, как должны масштабироваться изображения. У старых читателей электронных книг, кажется, есть проблемы с файлами jpg (по крайней мере, мой древний Kindle).
Как создать файл epub
См. Пример сайта . Чтобы создать собственную электронную книгу, вам нужно всего лишь изменить метаданные в config.toml и заменить Page-Resources в папке content/blog/ своим собственным содержимым в формате уценки. Кроме того, файл static/OEBPS/cover.jpg необходимо заменить на собственную обложку (в идеале в портретном формате). Не меняйте имя файла и формат изображения обложки.

При обращении hugoк корневому каталогу проекта HUGO в общей папке создается демонстрационная электронная книга, но она все еще не распакована. Чтобы получить желаемый формат epub, содержимое публичного каталога необходимо заархивировать. Zip-архив должен иметь расширение .epub.
Важно: файл mimetype должен быть первым файлом в zip-архиве. Таким образом, вызов zip должен быть таким, чтобы создать электронную книгу с именем ebook.epub , расположенную в корневом каталоге HUGO:

cd public
zip -rX ../ebook.epub mimetype OEBPS META-INF
Чтобы избежать появления файлового мусора в готовой электронной книге, перед повторным созданием книги необходимо удалить каталог public/ и файл zip/epub. Для среды Linux в тему включен скрипт развертывания bash, который выполняет все шаги автоматически:

deploy.sh:

#!/bin/bash
hugo --cleanDestinationDir
cd public
rm -f ../ebook.epub
zip -rX ../ebook.epub mimetype OEBPS META-INF
Хорошо знать
Тема использует HUGO Page Bundles для автоматического управления изображениями . Если вы хотите интегрировать изображения в свои ресурсы, вы можете сделать это с помощью шорткода
{{< image src="image name" caption="image caption" >}}
Достаточно указать подстроку имени изображения, если как он уникален. В настоящее время тема поддерживает только изображения в формате jpg и png. Автоматическое определение MIME-типа в манифесте content.opf может нуждаться в некотором улучшении и при необходимости может быть скорректировано в index.opf . Как правило, все имена файлов и папок должны быть без специальных символов, так как это может привести к ошибкам проверки.

Кто хочет встроить статические изображения из папки static/ , должен учитывать три вещи:
1. изображения должны находиться в каталоге static/OEBPS/ .
2. каждый файл изображения должен быть указан в манифесте (в шаблоне index.opf ). В качестве примера можно использовать уже существующую запись для cover.jpg .
3. файлы должны быть адресованы в содержании относительно, например![Alt-Text](../my-image.jpg)

Файлы Epub с ошибками проверки обычно все еще отображаются читателями. Однако, конечно, лучше, если электронная книга формально свободна от ошибок. Настоятельно рекомендуемое программное обеспечение для управления электронными книгами Calibre предлагает возможность редактировать книги и в этом контексте также проверять наличие ошибок и устранять их. Другие валидаторы: онлайн-валидатор Epub и программа проверки EPUB pagina (бесплатно) .

В автоматической генерации манифеста в content.opf и оглавлении ( single.xhtml ) есть хак , для которого я не смог придумать лучшего решения. HUGO будет генерировать пути для относительных URL-адресов, которые выглядят примерно так: ../OEBPS/chapter/chapter-1.xhtml . Теоретически это правильно, но некоторые читатели электронных книг (а также Calibre) плохо справляются с этим и нарушают порядок глав. Поэтому я преобразовываю путь последующей заменой . Я вырезал ../OEBPS/ из пути, чтобы он выглядел как Chapter/chapter-1.xhtml .

Кстати, для ручных внутренних ссылок между статьями автоматические относительные пути HUGO работают нормально. Для этого следует использовать внутренний реф-шорткод .

Есть также два шорткода, которые генерируют титульную страницу и могут быть настроены при необходимости: cover.html и covertext.html .

Получить тему
Создайте новый сайт Hugo:

$ hugo new site yoursite
Запустите из корня вашего сайта Hugo:

$ git clone https://github.com/weitblick/epub.git themes/epub
Демонстрационная электронная книга
электронная книга.epub

Лицензия
